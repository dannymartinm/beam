#Creating instance template
gcloud compute instance-templates create github-actions-template-windows --project=apache-beam-testing --machine-type=e2-standard-2 --network-interface=network=default,network-tier=PREMIUM --metadata=^,@^sysprep-specialize-script-ps1=\$env:Path\ \+=\ \'\;C:\\Program\ Files\\git\\bin\'\ $'\n'$'\n'Write-Output\ \$Env:Path$'\n'\ \ $'\n'\$currentLocation=\ \$PWD$'\n'$'\n'\$response=\ Invoke-RestMethod\ https://api.github.com/repos/actions/runner/tags$'\n'\$version=\ \$response\[0\].name.substring\(1,\$response\[0\].name.Length-1\)$'\n'Set-Location\ C:/$'\n'$'\n'mkdir\ \"actionsDir\"\ \ \ \ $'\n'$'\n'Set-Location\ \"actionsDir\"$'\n'$'\n'Invoke-WebRequest\ -Uri\ https://github.com/actions/runner/releases/download/v\$version/actions-runner-win-x64-\$version.zip\ -OutFile\ actions-runner-win-x64-\$version.zip$'\n'$'\n'Expand-Archive\ -LiteralPath\ \$PWD\\actions-runner-win-x64-\$version.zip\ -DestinationPath\ \$PWD\ -Force$'\n'$'\n'Write-Output\ \"Starting\ registration\ process\"$'\n'$'\n'\$registration_url=\"https://api.github.com/repos/elink21/beam/actions/runners/registration-token\"$'\n'Write-Output\ \"Requesting\ registration\ URL\ at\ \'\$\{registration_url\}\'\"$'\n'$'\n'\$GITHUB_TOKEN=\"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\"$'\n'$'\n'\$payload=\ Invoke-WebRequest\ \$\{registration_url\}\ -UseBasicParsing\ -Method\ \'POST\'\ -Headers\ @\{\'Authorization\'=\"token\ \$GITHUB_TOKEN\"\}\ \|\ ConvertFrom-Json$'\n'$'\n'\$hostname=\ \$env:COMPUTERNAME\+\[guid\]::NewGuid\(\)$'\n'$'\n'./config.cmd\ --name\ \$hostname\ --token\ \$payload.token\ --url\ https://github.com/elink21/beam\ --work\ _work\ --unattended\ --replace\ --labels\ windows,windows-latest$'\n'$'\n'./run.cmd --maintenance-policy=MIGRATE --service-account=844138762903-compute@developer.gserviceaccount.com --scopes=https://www.googleapis.com/auth/cloud-platform --tags=http-server,https-server --create-disk=auto-delete=yes,boot=yes,device-name=instance-template-windows-runner,image=projects/apache-beam-testing/global/images/disk-image-windows-runner,mode=rw,size=70,type=pd-balanced --no-shielded-secure-boot --shielded-vtpm --shielded-integrity-monitoring --reservation-affinity=any
#Creating instance group 
gcloud compute instance-groups managed create instance-group-windows-runners --project=apache-beam-testing --base-instance-name=instance-group-windows-runners --size=1 --template=github-actions-template-windows --zone=us-central1-a

#Config instance group
gcloud beta compute instance-groups managed set-autoscaling instance-group-windows-runners --project=apache-beam-testing --zone=us-central1-a --cool-down-period=300 --max-num-replicas=3 --min-num-replicas=1 --mode=on --target-cpu-utilization=0.7
